#!/bin/bash
# install-hooks.sh
# Install checkpoint hooks for Claude Code and/or Droid CLI
#
# Usage: install-hooks.sh [--dry-run] [--project] [tier]
#   --project: Install to project directories (.claude/hooks, .factory/hooks)
#              Default: Install to user directories (~/.claude/hooks, ~/.factory/hooks)
#   tier: minimal, balanced (default), aggressive

set -euo pipefail

# Configuration
TIER="balanced"
DRY_RUN=false
PROJECT_INSTALL=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --project)
            PROJECT_INSTALL=true
            shift
            ;;
        minimal|balanced|aggressive)
            TIER="$1"
            shift
            ;;
        *)
            echo "Usage: $0 [--dry-run] [--project] [minimal|balanced|aggressive]" >&2
            exit 1
            ;;
    esac
done

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ Checkpoint/Rewind Hook Installer"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Scope: $([ "$PROJECT_INSTALL" == "true" ] && echo "PROJECT-LEVEL" || echo "USER-LEVEL")"
echo "Tier: $TIER"
[[ "$DRY_RUN" == "true" ]] && echo "Mode: DRY RUN (no changes will be made)"
echo ""

# Check prerequisites
echo "Checking prerequisites..."

if ! command -v node &>/dev/null; then
    echo "âŒ Node.js not found. Please install Node.js first." >&2
    exit 1
fi
echo "âœ“ Node.js: $(node --version)"

if ! command -v jq &>/dev/null; then
    echo "âŒ jq not found. Please install jq first (sudo apt install jq)" >&2
    exit 1
fi
echo "âœ“ jq: $(jq --version)"

if ! command -v claudepoint &>/dev/null; then
    echo "âš ï¸  ClaudePoint not found. Install with: npm install -g claudepoint"
    echo "   (Installation will continue, but checkpoints won't work without it)"
fi

echo ""

# Detect available agents
echo "Detecting AI coding agents..."
AGENTS=()

if [[ -d "$HOME/.claude" ]]; then
    AGENTS+=("claude-code")
    echo "âœ“ Claude Code detected"
fi

if [[ -d "$HOME/.factory" ]]; then
    AGENTS+=("droid-cli")
    echo "âœ“ Droid CLI detected"
fi

if [[ ${#AGENTS[@]} -eq 0 ]]; then
    echo "âŒ No compatible agents found (Claude Code or Droid CLI)" >&2
    exit 1
fi

echo ""

# Install files function
install_files() {
    echo "Installing checkpoint system files..."
    
    # Create directories
    if [[ "$DRY_RUN" == "false" ]]; then
        mkdir -p "$HOME/.local/bin"
        mkdir -p "$HOME/.local/lib/checkpoint-rewind/parsers"
        mkdir -p "$HOME/.local/lib/checkpoint-rewind/metadata"
        mkdir -p "$HOME/.local/lib/checkpoint-rewind/rewind"
        mkdir -p "$HOME/.config/checkpoint-rewind/tiers"
        mkdir -p "$HOME/.claude-checkpoints"
        mkdir -p "$HOME/.factory-checkpoints"
    else
        echo "[DRY RUN] Would create directories:"
        echo "  - $HOME/.local/bin"
        echo "  - $HOME/.local/lib/checkpoint-rewind/{parsers,metadata,rewind}"
        echo "  - $HOME/.config/checkpoint-rewind/tiers"
        echo "  - $HOME/.claude-checkpoints"
        echo "  - $HOME/.factory-checkpoints"
    fi
    
    # Copy main script
    if [[ "$DRY_RUN" == "false" ]]; then
        cp "$SCRIPT_DIR/smart-checkpoint.sh" "$HOME/.local/bin/"
        chmod +x "$HOME/.local/bin/smart-checkpoint.sh"
        echo "âœ“ Installed smart-checkpoint.sh to ~/.local/bin/"
    else
        echo "[DRY RUN] Would copy: smart-checkpoint.sh â†’ ~/.local/bin/"
    fi
    
    # Copy rewind script
    if [[ "$DRY_RUN" == "false" ]]; then
        cp "$SCRIPT_DIR/checkpoint-rewind-full.sh" "$HOME/.local/bin/"
        chmod +x "$HOME/.local/bin/checkpoint-rewind-full.sh"
        echo "âœ“ Installed checkpoint-rewind-full.sh to ~/.local/bin/"
    else
        echo "[DRY RUN] Would copy: checkpoint-rewind-full.sh â†’ ~/.local/bin/"
    fi
    
    # Copy Node.js modules to installed location
    if [[ "$DRY_RUN" == "false" ]]; then
        cp "$PROJECT_ROOT/lib/parsers/SessionParser.js" \
           "$HOME/.local/lib/checkpoint-rewind/parsers/"
        cp "$PROJECT_ROOT/lib/metadata/ConversationMetadata.js" \
           "$HOME/.local/lib/checkpoint-rewind/metadata/"
        cp "$PROJECT_ROOT/lib/rewind/ConversationTruncator.js" \
           "$HOME/.local/lib/checkpoint-rewind/rewind/"
        echo "âœ“ Installed Node.js modules to ~/.local/lib/checkpoint-rewind/"
    else
        echo "[DRY RUN] Would copy:"
        echo "  - SessionParser.js â†’ ~/.local/lib/checkpoint-rewind/parsers/"
        echo "  - ConversationMetadata.js â†’ ~/.local/lib/checkpoint-rewind/metadata/"
        echo "  - ConversationTruncator.js â†’ ~/.local/lib/checkpoint-rewind/rewind/"
    fi
    
    # Copy tier configuration files (script parameters)
    if [[ "$DRY_RUN" == "false" ]]; then
        cp "$PROJECT_ROOT/configs/"*-tier.json "$HOME/.config/checkpoint-rewind/tiers/"
        echo "âœ“ Installed tier configs to ~/.config/checkpoint-rewind/tiers/"
    else
        echo "[DRY RUN] Would copy tier configs to ~/.config/checkpoint-rewind/tiers/"
    fi
    
    echo ""
}

# Update settings for an agent
update_agent_settings() {
    local agent="$1"
    local settings_file=""
    local hook_template=""
    
    case "$agent" in
        claude-code)
            settings_file="$HOME/.claude/settings.json"
            hook_template="$PROJECT_ROOT/hooks/${TIER}-hooks.json"
            ;;
        droid-cli)
            settings_file="$HOME/.factory/settings.json"
            hook_template="$PROJECT_ROOT/hooks/${TIER}-hooks.json"
            ;;
    esac
    
    echo "Configuring hooks for $agent..."
    echo "Settings file: $settings_file"
    
    # Verify hook template exists
    if [[ ! -f "$hook_template" ]]; then
        echo "âŒ Hook template not found: $hook_template" >&2
        return 1
    fi
    
    # Backup existing settings
    if [[ -f "$settings_file" ]]; then
        local backup_file="${settings_file}.backup.$(date +%s)"
        if [[ "$DRY_RUN" == "false" ]]; then
            cp "$settings_file" "$backup_file"
            echo "âœ“ Backed up existing settings to: $backup_file"
        else
            echo "[DRY RUN] Would backup to: $backup_file"
        fi
    else
        echo "  No existing settings.json found"
    fi
    
    # Merge or create settings
    if [[ "$DRY_RUN" == "false" ]]; then
        if [[ -f "$settings_file" ]]; then
            # Merge: preserve existing settings, add/replace hooks
            # Note: Droid adds comments to settings.json even though it's not documented
            # Strip // comments before jq can process it
            grep -v '^\s*//' "$settings_file" > "${settings_file}.clean"
            
            # Merge the cleaned settings with hook template
            jq -s '.[0] * .[1]' "${settings_file}.clean" "$hook_template" > "${settings_file}.tmp"
            mv "${settings_file}.tmp" "$settings_file"
            rm "${settings_file}.clean"
            echo "âœ“ Merged hooks into existing settings (stripped comments)"
        else
            # New file: just copy hook template
            cp "$hook_template" "$settings_file"
            echo "âœ“ Created new settings with hooks"
        fi
    else
        echo "[DRY RUN] Would merge/create settings with hooks from: $hook_template"
    fi
    
    echo ""
}

# Set CHECKPOINT_TIER environment variable
set_tier_env() {
    echo "Configuring CHECKPOINT_TIER environment variable..."
    
    # Determine shell profile
    local shell_profile=""
    if [[ -f "$HOME/.zshrc" ]]; then
        shell_profile="$HOME/.zshrc"
    elif [[ -f "$HOME/.bashrc" ]]; then
        shell_profile="$HOME/.bashrc"
    else
        echo "âš ï¸  No .bashrc or .zshrc found, skipping environment variable setup"
        echo "   You'll need to manually set: export CHECKPOINT_TIER=$TIER"
        return
    fi
    
    if [[ "$DRY_RUN" == "false" ]]; then
        # Check if already exists
        if grep -q "CHECKPOINT_TIER" "$shell_profile"; then
            echo "  CHECKPOINT_TIER already exists in $shell_profile"
        else
            echo "" >> "$shell_profile"
            echo "# Checkpoint/Rewind System" >> "$shell_profile"
            echo "export CHECKPOINT_TIER=$TIER" >> "$shell_profile"
            echo "âœ“ Added CHECKPOINT_TIER=$TIER to $shell_profile"
        fi
    else
        echo "[DRY RUN] Would add to $shell_profile:"
        echo "  export CHECKPOINT_TIER=$TIER"
    fi
    
    echo ""
}

# Install files
install_files

# Update each agent
for agent in "${AGENTS[@]}"; do
    update_agent_settings "$agent"
done

# Set environment variable
set_tier_env

# Print completion message
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [[ "$DRY_RUN" == "true" ]]; then
    echo "âœ“ Dry run complete - no changes made"
else
    echo "âœ… Installation complete!"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [[ "$DRY_RUN" == "false" ]]; then
    echo "Next steps:"
    echo "  1. Restart your shell (or run: source ~/.bashrc)"
    echo "  2. Restart your agent:"
    for agent in "${AGENTS[@]}"; do
        case "$agent" in
            claude-code)
                echo "     â€¢ Exit and restart Claude Code"
                ;;
            droid-cli)
                echo "     â€¢ Exit and restart Droid CLI"
                ;;
        esac
    done
    echo ""
    echo "  3. Test automatic checkpointing:"
    echo "     cd ~/test-project"
    echo "     claude  # (or droid)"
    echo "     # Make a code change (create/edit file)"
    echo "     # Exit agent"
    echo "     claudepoint list  # Should see 'Auto: Before...' checkpoint"
    echo ""
    echo "  4. Check conversation metadata:"
    echo "     cat ~/test-project/.claudepoint/conversation_metadata.json | jq"
    echo ""
    echo "Installed for: ${AGENTS[*]}"
    echo "Tier: $TIER"
    echo ""
    echo "Configuration locations:"
    echo "  â€¢ Hook scripts: ~/.local/bin/"
    echo "  â€¢ Tier configs: ~/.config/checkpoint-rewind/tiers/"
    echo "  â€¢ Hook registration: ~/.claude/settings.json (or ~/.factory/settings.json)"
else
    echo "Run without --dry-run to actually install."
fi
echo ""
